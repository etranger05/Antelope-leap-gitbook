# Nodeos Storage 와 Read mode 에 대하여

## 개요

Mandel 플랫폼은 다양한 트랜잭션 라이프 사이클 단계에 있는 다양한 데이터 구조에 블록체인 정보를 저장합니다. 본문에서 그 중 일부 데이터 구조를 설명하려고 합니다. 블록 생산 노드는 블록 생산자(BP, Block Producer)가 운영하는 nodeos 프로세스 인스턴스이며, 블록체인 네트워크에 필요한 블록을 만듭니다. BP 는 6초마다 변경되며, 다른 생산자로 전환되기 전에 12개의 블록(1초당 2블록 x 6초)을 순차적으로 만들어 냅니다.

## 블럭 체인 상태와 스토리지

nodeos 인스턴스는 블록체인의 상태를 유지하기 위해 파일을 생성하고 저장합니다. 이러한 파일은 디폴트로 `~/eosio/nodeos/data` 디렉토리에 저장되며 각 파일의 용도는 다음과 같습니다.

* **blocks.log** \
  디스크에 기록되며 추가만 할 수 있는 비가역성 (irreversible, 되돌릴 수 없는) 블록입니다. 여기에 저장된 블록들은 최종적으로 확인된 트랜잭션을 포함하고 있습합니다.
* **가역성 블록** (**reversible\_blocks)**\
  ****메모리 매핑된 파일이며 블록체인에 기록되었지만 아직 비가역 상태(irreversible)로 전환 되지 않은 블록이 포함되어 있으며, 이 블록에는 컨센서스 프로토콜을 통하여 최종 확인을 받기 위해 대기 중인, 유효한 푸시 트랜잭션이 포함되어 있습니다. 블록체인에 기록된 마지막 블록을 헤드 블록(head block)이라고 하며, 가역성 블록으로서 저장됩니다.
* **체인 상태(Chain State) 또는 체인 데이터베이스(Chain Database)** \
  현재 메모리 매핑된 파일에 저장되고 캐시됩니다. 계정 상세 내역, 지연된 트랜잭션, 스마트 컨트랙트에 멀티 인덱스 테이블을 사용하여 저장된 데이터 등등 각 블록과 연관된 블록체인 상태를 가지고 있습니다. 또한 마지막 65,536개의 블록 ID는 TaPOS(Transaction as Proof of Stake)를 지원하기 위해 캐시됩니다. 트랜잭션 ID/만료도 트랜잭션이 만료될 때까지 캐시됩니된다.
* **보류 중인 블록(Pending block)**\
  ****어떤 트랜잭션이 처리되어 블록에 푸시될 때 그 트랜잭션이 들어 있는 메모리 블록입니다. 이 블록은 나중에 헤드 블록이 될 수도 있습니다. nodeos 인스턴스가 BP 노드인 경우 보류 중인 블록은 다른 nodeos 인스턴스로 배포됩니다.
* 체인 상태 밖에서는 블록 데이터가 확정되고 비가역 상태가 될 때(특히 서명된 블록)까지 RAM에 캐시됩니다. LIB(Last Irreversible Block)가 캐시된 블록을 따라잡으면 해당 블록은 비가역성 블록 로그에서 검색됩다.

## Mandel 인터페이스

Mandel 은 스마트 컨트랙트 개발자가 작업 전반에 걸쳐 상태를 유지할 수 있도록 하는 여러가지 서비스와 인터페이스를 제공한다. 스마트 컨트랙트는 이러한 서비스와 인터페이스를 다양한 용도로 사용할 수 있습니다. 예를 들어, `eosio.token` 컨트랙트는 체인 데이터베이스네 모든 사용자의 토큰 잔액을 가지고 있습니다. 각 노드 인스턴스는 데이터베이스를 메모리에 보관하므로 스마트 컨트랙트에서 데이터를 쉽게 읽고 쓸 수 있습니다.

## Nodeos RPC API

nodeos 서비스는 HTTP RPC API 를 통하여 체인 데이터베이스에 접근할 수 있는 인터페이스를 제공합니다.

## Nodeos 읽기 모드(Read Modes)

nodeos 서비스는 여러가지 "읽기" 모드에서 실행 될 수 있습니다. 이러한 모드들은 노드의 작동 방식과 블록 및 트랜잭션 처리 방식을 제어합니다.

* **Speculative(추측)모드**\
  ****확인된 거래와 확인되지 않은 트랜잭션의 부작용(side-effect)을 포함합니다.
* **head**\
  ****확인된 트랜잭션의 부작용만 포함합니다. 이 모드에서는 확인되지 않은 트랜잭션도을 처리하기는 하지만 이러한 트랜잭션을 포함하지는 않습니다.
* **read-only**\
  ****이 모드는 더 이상 사용되지 않습니다(deprecated). 대신 \*\*`[read-mode = head, p2p-accept-transactions = false, api-accept-transactions = false]`\*\*를 조합하면 비슷하게 동작합니다. 이 옵션이 설정되면 로컬 데이터베이스의 헤드 블록까지 체인에 있는 트랜잭션에 의해 수행된 상태 변경 사항이 포함됩니다. 또한 P2P 네트워크를 통해 수신된 트랜잭션은 중계(relay)되지 않으며 체인 API를 통해 트랜잭션을 푸시할 수 없습니다.
* **irreversible**\
  ****이 모드에서는 마지막 비가역성 블록에 포함된 트랜잭션까지의 확인된 트랜잭션만 포함됩니다.

nodeos 인스턴스가 블록체인상의 블록에 수신, 처리 내역을 작성했을 때 트랜잭션이 확인되는 것으로 간주됩니다. 예를 들어 비가역성인 헤드 블록 또는 그보다 이전 블록에 포함된 경우 입니다.

### **추측(Speculative) 모드**

cleos 및 RPC API 와 같은 클라이언트는 현재 헤드 블록과 더불어, 현재 이 노드가 알고 있는, 모든 트랜잭션에 의해 수행된 변경 사항에 대한 데이터베이스 상태를 확인할 수 있습니다. 그러나 이 중에는 확정되지 않은 트랜잭션과 잠재적으로 체인에 포함되지 않은 데이터베이스 상태도 있을 수 있습니다.

Speculative 모드는 지연 시간은 낮지만 깨지기 쉬우며, 상태에 반영되는 트랜잭션이가 체인에 포함되거나 상태가 암시하는 순서와 동일한 순서로 반영된다는 보장은 없습니다.

이 모드는 지연 시간이 가장 짧지만 일관성을 보장하기 어렵습니다.

Speculative 모드에서 노드는 TaPoS(Transaction as Possible of Stake)가 이 노드에 의해 가장 나은 포크로 간주되는 포크의 유효한 블록을 가리키는 트랜잭션을 실행할 수 있습니다.

### Head Mode( 헤드 모드)

cleos 및 RPC API와 같은 클라이언트는 체인의 현재 헤드 블록을 기준으로 데이터베이스 상태를 표시합니다. 현재 헤드 블록은 아직 비가역 상태가 아니며 수명이 짧은 포크가 발생할 수 있기 때문에 nodeos 가 다른 포크로 전환하면 이 모드에서 상태 판독값이 부정확해 질 수 있습다. 이는 Speculative 모드에서도 마찬가지 입니다.

이 모드는 데이터를 확인할 때 일관된 데이터와 지연 시간 사이의 적당한 균형을 맞출 수 있습니다.

이 모드에서 노드는 TaPoS가 이 노드에 의해 최상의 포크로 간주되는 포크의 유효한 블록을 가리키는 트랜잭션을 실행할 수 있습니다.

### Read-Only Mode (읽기 전용 모드)

{% hint style="info" %}
**Deprecation**&#x20;

`read-mode = read-only` 모드는 더 이상 사용되지 않습니다. 대신 **read-mode = head, p2p-accept-transactions = false, api-accept-transactions = false** 옵션을 결합하면 비슷하게 기능합니다.
{% endhint %}

cleos 및 RPC API와 같은 클라이언트는 체인의 현재 헤드 블록을 기준으로 데이터베이스 상태를 표시합니다. 여기에는 확인되지 않은 트랜잭션과 같이, 이 노드까지 전달되었지만 체인에는 포함되지 않은 트랜잭션에 의해 변경된 내용은 포함되지 않습니다.

### Irreversible Mode(비가역 모드)

nodeos가 비가역 읽기 모드로 구성되어 있으면 포크 데이터베이스에서 최신 블록을 추적하지만 상태가 현재 최신의 헤드 블록(포크 DB 헤드라고도 함)에 뒤쳐져 항상 마지막 비가역성 블록의 상태를 반영합니다. cleos 및 RPC API와 같은 클라이언트는 체인의 현재 헤드 블록을 기준으로 데이터베이스 상태를 표시합니다. 여기에는 확인되지 않은 트랜잭션과 같이 이 노드까지 전달되었지만 체인에 포함되지 않은 트랜잭션에 의해 변경된 내용은 포함되지 않습니다.

### 읽기 모드를 지정하는 방법

읽기 모드는 `eosio::chain_plugin` 의 `--read-mode` 옵션을 사용하여 지정할 수 있습니다.
